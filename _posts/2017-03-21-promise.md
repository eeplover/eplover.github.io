---
layout: post
title: Why Promise
categories: pages
excerpt: Promise
tags: javascript
---

æ•…äº‹æ˜¯è¿™æ ·çš„ï¼šå°é“å»æŸå‚é¢è¯•è¢«é—®åˆ°ï¼šâ€œ`Promise`çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å“ªäº›é—®é¢˜ï¼Ÿâ€ï¼Œä»–èƒ¸æœ‰æˆç«¹è„±å£è€Œå‡ºï¼šâ€œ`Promise`çš„å‡ºç°æ˜¯ä¸ºæé«˜ä»£ç çš„å¯è¯»æ€§ï¼Œç”¨åŒæ­¥çš„æ–¹å¼æ¥å†™å¼‚æ­¥â€ã€‚ç„¶é¹…ï¼Œé¢è¯•å®˜å¯¹è¿™ä¸ªå›ç­”å¹¶ä¸æ»¡æ„ï¼Œè¯´ï¼šâ€œè¿™åªæ˜¯ä¸€æ–¹é¢ï¼Œå¹¶æ²¡æœ‰ç­”åˆ°ç‚¹ä¸Šã€‚`Promise`çš„å‡ºç°æ˜¯ä¸ºäº†......â€ã€‚äº‹åå°é“å‘ç°è‡ªå·±å¯¹`Promise`çš„ç†è§£è¿˜åªæ˜¯åœç•™åœ¨è¡¨é¢ï¼Œæ‰€ä»¥æœ‰äº†ä¸‹é¢è¿™ç¯‡`Promise`çŸ¥è¯†ç‚¹çš„æ€»ç»“ã€‚   

å°é“è§‰å¾—è¦æ·±åˆ»çš„ç†è§£ä¸€ä¸ªæ¦‚å¿µï¼Œå¤§ä½“å¯ä»¥ä»ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜å‡ºå‘ã€‚

1. æ˜¯ä»€ä¹ˆ ï¼Ÿ
2. ä¸ºä»€ä¹ˆ ï¼Ÿ
3. æ€ä¹ˆåš ï¼Ÿ

é‚£ä¹ˆï¼Œä¸‹é¢æˆ‘ä»¬å°±å¸¦ç€è¿™ä¸‰ä¸ªé—®é¢˜æ’¸ä¸€æ’¸`Promise`å§ ~

æ…¢ç€ï¼`Promise`æ˜¯ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œç›´æ¥å»ç†è§£ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µä¼¼ä¹å¹¶ä¸å®¹æ˜“ã€‚æˆ‘ä»¬å…ˆææ‡‚ä¸ºä»€ä¹ˆï¼Œå†å»æ¢ç´¢å®ƒæ˜¯ä»€ä¹ˆä¼šä¸ä¼šæ›´å®¹æ˜“ä¸€äº›å‘¢ï¼Ÿ


### ä¸ºä»€ä¹ˆéœ€è¦ Promise

```javascript
function getUser(name) {
  var sql = 'SELECT * FROM users WHERE name=?'
  var user = query(sql, name) // <- blocking
  if (!user) throw new Error('no user!')
  return user
}
```

ä¸Šé¢è¿™æ®µä»£ç å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼ŒæŸ¥åº“æ–¹æ³•`query()`ä¼šé˜»å¡åç»­ä»£ç çš„æ‰§è¡Œï¼Œç›´è‡³æ•°æ®åº“è¿”å›æŸ¥è¯¢ç»“æœã€‚  

æ¥ç€ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢è¿™æ®µä»£ç 

```javascript
function getUser(name, callback) {
  var sql = 'SELECT * FROM users WHERE name=?'
  query(sql, name, function (error, user) {
    if (error) {
      callback(error) // ä¸ºä»€ä¹ˆä¸æ˜¯ throw ï¼Ÿ
    } else if (!user) {
      callback(new Error('no user!'))
    } else {
      callback(null, user)
    }
    // ä¸ºä»€ä¹ˆæ²¡æœ‰ return ?
  })
}
```

`query()`å…è®¸å°†ä¸€ä¸ªå‡½æ•°ä½œä¸ºç¬¬ä¸‰å‚æ•°ä¼ å…¥ï¼Œè€Œä¸”è¿™é‡Œçš„`query()`ä¸ä¼šé˜»å¡åç»­ä»£ç çš„æ‰§è¡Œã€‚
è¿™ä¸ªä½œä¸ºå‚æ•°çš„å‡½æ•°å°±æ˜¯å›è°ƒå‡½æ•°ï¼Œå®ƒä¼šåœ¨æ•°æ®åº“è¿”å›æŸ¥è¯¢ç»“æœçš„æ—¶å€™è¢«æ‰§è¡Œï¼Œæ˜¯å¼‚æ­¥çš„ã€‚  

**æ‰€ä»¥ï¼Œé€šè¿‡å›è°ƒå‡½æ•°çš„æ–¹å¼æˆ‘ä»¬è§£å†³äº†é˜»å¡çš„é—®é¢˜ã€‚**  

ä½†æ˜¯ï¼Œå›è°ƒå‡½æ•°å­˜åœ¨ä»¥ä¸‹å››ä¸ªå±€é™ã€‚  

**ä¸€ã€ åœ¨å›è°ƒå‡½æ•°é‡Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨å…³é”®å­— throw å’Œ returnäº†ã€‚**

> å›è°ƒå‡½æ•°æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥å›è°ƒå‡½æ•°å†…éƒ¨é€šè¿‡`throw`æŠ›å‡ºçš„å¼‚å¸¸æ— æ³•è¢«å¤–éƒ¨çš„`try catch`æ•è·


**äºŒã€ å›è°ƒå‡½æ•°çš„æ‰§è¡Œæ¬¡æ•°å¾—ä¸åˆ°ä¿è¯ã€‚æ€ä¹ˆç†è§£å‘¢ï¼Ÿä¸¾ä¸ªğŸŒ°**

> ```javascript
  function getUsers(names, callback) {
    var sql = 'SELECT * FROM users WHERE name=?'
    var users = []
    names.forEach(name => {
      query(sql, name, function (error, user) {
        if (error) {
          callback(error)
        } else if (!user) {
          callback(new Error('no user!'))
        } else {
          users.push(user)
          if (users.length === names.length) {
            callback(null, users)
          }
        }
      })
    })
  }
  ```
  å½“namesä¸ºä¸¤ä¸ªæ— æ•ˆçš„ç”¨æˆ·åé›†åˆï¼Œ`query()`æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œcallbackä¾ç„¶ä¼šè¢«æ‰§è¡Œä¸¤æ¬¡ï¼ï¼


**ä¸‰ã€ å›è°ƒå‡½æ•°ä¸­ä¸èƒ½åˆ©ç”¨å‡½æ•°çš„è°ƒç”¨æ ˆäº†ã€‚ç”±å›è°ƒå‡½æ•°çš„å¼‚æ­¥æ€§è´¨å¯¼è‡´ã€‚**

> å¦‚æœä½ ä¸çŸ¥é“å‡½æ•°è°ƒç”¨æ ˆçš„ä½œç”¨ï¼Œå¯ä»¥çœ‹ä¸‹è¿™ç¯‡æ–‡ç« [ä½ ä¸çŸ¥é“çš„ JS é”™è¯¯å’Œè°ƒç”¨æ ˆå¸¸è¯†](https://zhuanlan.zhihu.com/p/25644447)


**å››ã€ å›è°ƒå‡½æ•°çš„æ˜“ç”¨æ€§ä¸é«˜ã€‚æ€ä¹ˆç†è§£å‘¢ï¼Ÿå†ä¸¾ä¸ªğŸŒ°ï¼š**

> ```javascript
  getUser('mjackson', function (user) {
    getNewTweets(user, function (tweets) {
      updateTimeline(tweets)
    })
  })
  ```
  å½“å¤šä¸ªå¼‚æ­¥é€»è¾‘å­˜åœ¨å…ˆåä¾èµ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„ä»£ç å°±åƒå–æ°´éƒ½é•¿è†˜çš„èƒ–å­ï¼Œç¨ä¸ç•™ç¥å°±ä¼šæ¨ªå‘ç”Ÿé•¿ã€‚è¿™æ ·çš„ä»£ç ï¼ˆå›è°ƒåœ°ç‹±ï¼‰æ—¢ä¸åˆ©äºé˜…è¯»ä¹Ÿä¸åˆ©äºç»´æŠ¤ã€‚

> æ¨èé˜…è¯»è¿™ç¯‡å…³äºå›è°ƒåœ°ç‹±çš„æ–‡ç«  [Managing Node.js Callback Hell](https://medium.com/@wavded/managing-node-js-callback-hell-1fe03ba8baf)

<br>

æ€»ç»“ä¸€ä¸‹ä¸Šé¢è¯´çš„å‡ ä¸ªé—®é¢˜

1. **å›è°ƒå‡½æ•°å†…éƒ¨æ— æ³•ä½¿ç”¨å›è°ƒæ ˆï¼ˆæ— æ³•ä½¿ç”¨å…³é”®å­—throwå’Œreturnï¼‰**  

2. **å½“é”™è¯¯å‘ç”Ÿæ—¶ï¼Œå›è°ƒå‡½æ•°çš„æ‰§è¡Œæ¬¡æ•°å¾—ä¸åˆ°ä¿è¯**  

3. **å›è°ƒå‡½æ•°åµŒè¿‡å¤šéš¾ä»¥ç»´æŠ¤ï¼Œå¯è¯»æ€§å·®**

è€Œ`Promise`çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³äº†ä¸Šè¿°3ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹`Promise`åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ


### ä»€ä¹ˆæ˜¯ Promise
> A Promise is an object that is used as a placeholder for the eventual results of a deferred (and possibly asynchronous) computation.

ä»¥ä¸Šæ˜¯æ ‡å‡†ï¼ˆECMAï¼‰å¯¹Promiseçš„å®šä¹‰ã€‚   

é€šä¿—ç‚¹è¯´å°±æ˜¯ï¼šPromise å¯¹è±¡æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼ˆä»£ç†ä¸€ä¸ªå€¼ï¼‰ï¼Œè¢«ä»£ç†çš„å€¼åœ¨Promiseå¯¹è±¡åˆ›å»ºæ—¶å¯èƒ½æ˜¯æœªçŸ¥çš„ã€‚
å®ƒå…è®¸ä½ ä¸ºå¼‚æ­¥ä»£ç æ‰§è¡Œç»“æœçš„æˆåŠŸå’Œå¤±è´¥åˆ†åˆ«ç»‘å®šç›¸åº”çš„å¤„ç†æ–¹æ³•ï¼ˆresolve/rejectï¼‰ã€‚    

è¿™è®©å¼‚æ­¥æ–¹æ³•å¯ä»¥åƒåŒæ­¥æ–¹æ³•é‚£æ ·è¿”å›å€¼ï¼Œä½†æ˜¯å¹¶éç«‹å³è¿”å›æ‰§è¡Œçš„ç»“æœï¼Œå› ä¸ºæ¯•ç«Ÿæ‰§è¡Œçš„æ˜¯å¼‚æ­¥ä»£ç ï¼Œå› æ­¤ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå¦‚å‰æ‰€è¯´ï¼Œå®ƒæ˜¯ä¸€ä¸ªä»£ç†çš„å¯¹è±¡ï¼Œä»£ç†äº†æœ€ç»ˆè¿”å›çš„å€¼ï¼Œå¯ä»¥åœ¨åæœŸä½¿ç”¨ã€‚

Promiseæœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€:

* pending: åˆå§‹çŠ¶æ€ã€‚
* fulfilled: æ„å‘³ç€æ“ä½œæˆåŠŸã€‚
* rejected: æ„å‘³ç€æ“ä½œå¤±è´¥ã€‚

![promiseæµç¨‹ç¤ºæ„å›¾](/images/promises.png)


åˆ›å»ºä¸€ä¸ªPromiseå¯¹è±¡ï¼Œåœ¨executorå‡½æ•°ä½“å†…æ‰§è¡Œå¼‚æ­¥æ“ä½œ ~

```javascript
new Promise(
    /* executor */
    function(resolve, reject){...}
);
```


**Promise.prototype.then()**

then() æ–¹æ³•è¿”å›ä¸€ä¸ª Promiseï¼Œç»‘å®šå¤„ç†å¼‚æ­¥ä»£ç æ‰§è¡Œçš„ç»“æœçš„å‡½æ•°ã€‚å®ƒæœ€å¤šéœ€è¦æœ‰ä¸¤ä¸ªå‚æ•°ï¼šPromiseçš„æˆåŠŸå’Œå¤±è´¥æƒ…å†µçš„å›è°ƒå‡½æ•°ã€‚   

è¯­æ³•
```javascript
p.then(onFulfilled, onRejected);
```

`Promise.prototype.then(onFulfilled, onRejected)`æ–¹æ³•è¿”å›ä¸€ä¸ªç”±`onFulfilled/onRejected`æ–¹æ³•ç¡®å®šçš„`Promise`ã€‚  

å½“`onFulfilled/onRejected`æ–¹æ³•æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªæ‹’ç»çš„`Promise` ï¼Œ`then`è¿”å›ä¸€ä¸ª`rejected Promise`ã€‚   

å½“`onFulfilled/onRejected`æ–¹æ³•è¿”å›ä¸€ä¸ª`fulfilled Promise`ï¼Œæˆ–è€…è¿”å›ä»»ä½•å…¶ä»–å€¼(æˆ–è€…æ²¡æœ‰åŠ¨æ€çš„è®¾ç½®è¿”å›å€¼)ï¼Œ`then`è¿”å›ä¸€ä¸ª`fulfilled Promise`ã€‚


**Promise.prototype.catch()**

catch() æ–¹æ³•è¿”å›ä¸€ä¸ªPromiseï¼Œåªå¤„ç†æ‹’ç»çš„æƒ…å†µã€‚å®ƒçš„è¡Œä¸ºä¸è°ƒç”¨Promise.prototype.then(undefined, onRejected) ç›¸åŒã€‚   

è¯­æ³•
```javascript
p.catch(onRejected);
```


**catch å’Œ onRejected çš„åŒºåˆ«**

```javascript
// A
new Promise(function(resolve, reject) {
  1 ? resolve() : reject()
}).then(function() {
  console.log('resolve');
}, function(err) {
  console.log('reject');
})
// B
new Promise(function(resolve, reject) {
  1 ? resolve() : reject()
}).then(function() {
  console.log('resolve');
}).catch(function(err) {
  console.log('reject');
})
// C
new Promise(function(resolve, reject) {
  1 ? resolve() : reject()
}).then(function() {
  console.log('resolve');
}).then(null, function(err) {
  console.log('reject');
})
```
Bå’ŒCå®Œå…¨ä¸€æ ·ã€‚Aå’ŒBæœ‰ç»†å¾®çš„åŒºåˆ«ï¼Œå½“ç¬¬ä¸€ä¸ª`onFulfilled`å†…æŠ›å‡ºå¼‚å¸¸æ—¶Açš„`onRejected`å¹¶ä¸ä¼šè¢«æ‰§è¡Œï¼ˆäºŒè€…ä¸èƒ½åŒæ—¶æ‰§è¡Œï¼‰ï¼Œè€ŒBçš„`catch`å›è°ƒä¼šè¢«æ‰§è¡Œã€‚


**Promise.all(iterable)**   

è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promiseå¯¹è±¡ï¼Œè¯¥`Promise`å¯¹è±¡åœ¨`iterable`é‡Œæ‰€æœ‰çš„Promiseå¯¹è±¡éƒ½æˆåŠŸçš„æ—¶å€™æ‰ä¼šè§¦å‘æˆåŠŸï¼Œä¸€æ—¦æœ‰ä»»ä½•ä¸€ä¸ª`iterable`é‡Œé¢çš„Promiseå¯¹è±¡å¤±è´¥åˆ™ç«‹å³è§¦å‘è¯¥`Promise`å¯¹è±¡çš„å¤±è´¥ã€‚   

è¿™ä¸ªæ–°çš„`Promise`å¯¹è±¡åœ¨è§¦å‘æˆåŠŸçŠ¶æ€ä»¥åï¼Œä¼šæŠŠä¸€ä¸ªåŒ…å«`iterable`é‡Œæ‰€æœ‰`Promise`è¿”å›å€¼çš„æ•°ç»„ä½œä¸ºæˆåŠŸå›è°ƒçš„è¿”å›å€¼ï¼Œé¡ºåºè·Ÿ`iterable`çš„é¡ºåºä¿æŒä¸€è‡´ï¼›å¦‚æœè¿™ä¸ªæ–°çš„`Promise`å¯¹è±¡è§¦å‘äº†å¤±è´¥çŠ¶æ€ï¼Œå®ƒä¼šæŠŠ`iterable`é‡Œç¬¬ä¸€ä¸ªè§¦å‘å¤±è´¥çš„`Promise`å¯¹è±¡çš„é”™è¯¯ä¿¡æ¯ä½œä¸ºå®ƒçš„å¤±è´¥é”™è¯¯ä¿¡æ¯ã€‚   

`Promise.all`æ–¹æ³•å¸¸è¢«ç”¨äºå¤„ç†å¤šä¸ª`Promise`å¯¹è±¡çš„çŠ¶æ€é›†åˆã€‚


**Promise.race(iterable)**    

å½“`iterable`å‚æ•°é‡Œçš„ä»»æ„ä¸€ä¸ªå­`Promise`æˆåŠŸæˆ–å¤±è´¥åï¼Œçˆ¶`Promise`é©¬ä¸Šä¹Ÿä¼šç”¨å­`Promise`çš„æˆåŠŸè¿”å›å€¼æˆ–å¤±è´¥è¯¦æƒ…ä½œä¸ºå‚æ•°è°ƒç”¨çˆ¶`Promise`ç»‘å®šçš„ç›¸åº”å¥æŸ„ï¼Œå¹¶è¿”å›è¯¥`Promise`å¯¹è±¡ã€‚


### é‚£...æ€ä¹ˆä½¿ç”¨ Promise å‘¢

ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ç”¨`Promise`æ€ä¹ˆè§£å†³ä¸Šè¿°ä¸‰ä¸ªé—®é¢˜ã€‚
Talk is cheap, show you the code !  

ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå›è°ƒå‡½æ•°å†…éƒ¨æ— æ³•ä½¿ç”¨å›è°ƒæ ˆï¼ˆæ— æ³•ä½¿ç”¨å…³é”®å­—throwå’Œreturnï¼‰

```javascript
function getUser(name) {
  var sql = 'SELECT * FROM users WHERE name=?'
  var user = query(sql, name) // <- blocking
  if (!user) throw new Error('no user!')
  return user
}

try {
  getUser('mjackson')
} catch(e) {
  console.error(e)
}

// using callbacks
function getUser(name, callback) {
  var sql = 'SELECT * FROM users WHERE name=?'
  query(sql, name, function (error, user) {
    if (error) {
      callback(error)
    } else if (!user) {
      callback(new Error('no user!'))
    } else {
      callback(null, user)
    }
  })
}

getUser('mjackson', (error, user) => {
  if (error) return console.error(error)
  console.log(user)
})

// using promises
function getUser(name) {
  var sql = 'SELECT * FROM users WHERE name=?'
  var executor = function (resolve, reject) {
    query(sql, name, (error, user) => {
      error ? reject(error) : resolve(user)
    })
  }
  return new Promise(executor)
}

getUser('mjackson')
  .then(user => {
    if (!user) throw new Error('no user!')
    return Promise.resolve(user)
  })
  .then(console.log, console.error)
```

ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå½“é”™è¯¯å‘ç”Ÿæ—¶ï¼Œå›è°ƒå‡½æ•°çš„æ‰§è¡Œæ¬¡æ•°å¾—ä¸åˆ°ä¿è¯

```javascript
// using callbacks
function getUsers(names, callback) {
  var sql = 'SELECT * FROM users WHERE name=?'
  var users = []
  names.forEach(name => {
    query(sql, name, function (error, user) {
      if (error) {
        callback(error)
      } else if (!user) {
        callback(new Error('no user!'))
      } else {
        users.push(user)
        if (users.length === names.length) {
          callback(null, users)
        }
      }
    })
  })
}

getUsers([NaN, true], (error, users) => {
  if (error) return console.error(error)
  console.log(users)
})

// using promises
function getUsers(names) {
  var sql = 'SELECT * FROM users WHERE name=?'
  var queryPromises = names.map(name => {
    var executor = function (resolve, reject) {
      query(sql, name, (error, user) => {
        error ? reject(error) : resolve(user)
      })
    }
    return new Promise(executor)
  })
  return Promise.all(queryPromises)
}

getUsers([NaN, true])
  .then(console.log, console.error)

```

ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œå›è°ƒå‡½æ•°åµŒè¿‡å¤šéš¾ä»¥ç»´æŠ¤ï¼Œå¯è¯»æ€§å·®

```javascript
var user = getUser('mjackson')
var tweets = getNewTweets(user)
updateTimeline(tweets)

// using callbacks
getUser('mjackson', function (user) {
  getNewTweets(user, function (tweets) {
    updateTimeline(tweets)
  })
})

// using promises
getUser('mjackson')
  .then(getNewTweets)
  .then(updateTimeline)
```


ä»¥ä¸Šæ˜¯å°é“è¿™æ¬¡çš„æ€»ç»“ ~  

<br>

æœ€åï¼Œæ€è€ƒä¸€ä¸‹é¢ 4 ä¸ª promise ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ« ï¼Ÿ

```javascript
  // doSomething,doSomethingElseå‡è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡
  doSomething().then(function () {
    return doSomethingElse()
  })

  doSomething().then(function () {
    doSomethingElse()
  })

  doSomething().then(doSomethingElse())

  doSomething().then(doSomethingElse)
```

> ç­”æ¡ˆè§ [We have a problem with promises](https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html)

<br><br>

å‚è€ƒæ–‡æ¡£ï¼š[MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)ã€[ECMA](http://www.ecma-international.org/ecma-262/7.0/index.html#sec-promise-objects)ã€[ä½ ä¸çŸ¥é“çš„ JS é”™è¯¯å’Œè°ƒç”¨æ ˆå¸¸è¯†](https://zhuanlan.zhihu.com/p/25644447)ã€[JavaScript Errors and Stack Traces in Depth](http://lucasfcosta.com/2017/02/17/JavaScript-Errors-and-Stack-Traces.html)
ã€[Redemption from Callback Hell](https://www.youtube.com/watch?v=hf1T_AONQJU&feature=youtu.be)
