---
layout: post
title: why Promise
categories: pages
excerpt: Promise
tags: javascript
---

æ•…äº‹æ˜¯è¿™æ ·çš„ï¼šå°é“å»æŸå‚é¢è¯•ï¼Œè¢«é—®åˆ°Promiseçš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å“ªäº›é—®é¢˜ï¼Ÿå°é“èƒ¸æœ‰æˆç«¹è„±å£è€Œå‡ºï¼šPromiseçš„å‡ºç°æ˜¯ä¸ºæé«˜ä»£ç çš„å¯è¯»æ€§,ç”¨åŒæ­¥çš„æ–¹å¼æ¥å†™å¼‚æ­¥ã€‚ç„¶é¹…ï¼Œé¢è¯•å®˜å¯¹è¿™ä¸ªå›ç­”å¹¶ä¸æ»¡æ„ï¼Œè¯´è¿™åªæ˜¯ä¸€æ–¹é¢ï¼Œå¹¶æ²¡æœ‰ç­”åˆ°ç‚¹ä¸Šã€‚Promiseçš„å‡ºç°æ˜¯ä¸ºäº† ...... å°é“å‘ç°è‡ªå·±å¯¹Promiseçš„ç†è§£è¿˜åªæ˜¯åœç•™åœ¨è¡¨é¢ï¼Œæ‰€ä»¥æœ‰äº†è¿™ç¯‡PromiseçŸ¥è¯†ç‚¹çš„æ€»ç»“ã€‚   

å°é“è§‰å¾—è¦æ·±åˆ»çš„ç†è§£ä¸€ä¸ªæ¦‚å¿µï¼Œå¤§ä½“å¯ä»¥ä»ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜å‡ºå‘
1. æ˜¯ä»€ä¹ˆ ï¼Ÿ
2. ä¸ºä»€ä¹ˆ ï¼Ÿ
3. æ€ä¹ˆåš ï¼Ÿ

é‚£ä¹ˆï¼Œä¸‹é¢æˆ‘ä»¬å°±å¸¦ç€è¿™ä¸‰ä¸ªé—®é¢˜æ’¸ä¸€æ’¸ Promise  

æ…¢ç€ï¼ŒPromise æ˜¯ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œç›´æ¥å»ç†è§£ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µä¼¼ä¹å¹¶ä¸å®¹æ˜“ã€‚æˆ‘ä»¬å…ˆææ‡‚ä¸ºä»€ä¹ˆï¼Œå†å»æ¢ç´¢å®ƒæ˜¯ä»€ä¹ˆä¼šä¸ä¼šæ›´å®¹æ˜“ä¸€äº›å‘¢

å¥½ï¼Œä¸æ‰¯é—²è›‹äº†ï¼Œæ­£å¼å¼€æ’¸ï¼

<br>

### ä¸ºä»€ä¹ˆéœ€è¦ Promise
```javascript
// fetch ä¸ºè·å–æ¥å£æ•°æ®çš„æ–¹æ³•
const api = 'xxx'
fetch(api, function(err, data) {
  fetch(data.api, function(err, data) {
    fetch(data.api, function(err, data) {
      fetch(data.api, function(err, data) {
        // Do something with value4
      });
    });
  });
});
```
å½“æˆ‘ä»¬çš„å¤šä¸ªå¼‚æ­¥é€»è¾‘å­˜åœ¨å…ˆåä¾èµ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è¿™ä¹ˆå†™ã€‚è¿™å°±æ˜¯â€˜è‡­åæ˜­è‘—â€™çš„å›è°ƒåœ°ç‹±ã€‚ä¸ºä»€ä¹ˆå«å›è°ƒåœ°ç‹±å‘¢ï¼Ÿå› ä¸ºè¿™ç§å†™æ³•ä¼šæœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜

1. ä»£ç åµŒå¥—è¿‡å¤šï¼Œæ¨ªå‘æ‰©å±•ï¼Œå¯è¯»æ€§å·®ã€‚
2. å¤–éƒ¨æ— æ³•æ•è·å›è°ƒå‡½æ•°å†…éƒ¨çš„é”™è¯¯ä¿¡æ¯ã€‚
3. å›è°ƒå‡½æ•°çš„æ‰§è¡Œæ¬¡æ•°æ— æ³•å¾—åˆ°ä¿è¯ã€‚

> æ³¨ï¼š  
  è¡¥å……è¯´ä¸‹ç¬¬äºŒç‚¹ï¼Œä¸¾ä¸ªğŸŒ°
  ```javascript
  const api = 'xxx'
  try { // è¿™é‡Œçš„ try catch æ— æ³•æ•è·å†…éƒ¨å›è°ƒå‡½æ•°å†…éƒ¨çš„é”™è¯¯ä¿¡æ¯
    fetch(api, function(error, data) {
      // è¿™é‡ŒæŠ›å‡ºçš„é”™è¯¯æ— æ³•è¢«æœ€å¤–å±‚çš„ try catch æ•è·
      if (error) throw new Error(error)
      try { // è¿™é‡Œæ˜¯ä¸ºäº†é¿å…è¿”å›çš„æ•°æ® data.api æœ‰è¯¯ï¼Œå¯¼è‡´fetchæŠ›å‡ºå¼‚å¸¸
        fetch(data.api, function(error, data) {
          if (error) {
            handleError(error)
          } else {
            try {
              fetch(data.api, function(error, data) {
                if (error) {
                  handleError(error)
                } else {
                  // ...
                }
              })
            } catch(e) { handleError(e) }
          }
        })
      } catch(e) { handleError(e) }
    })
  } catch(e) { handleError(e) }
  ```
  è¡¥å……è¯´ä¸‹ç¬¬ä¸‰ç‚¹ï¼Œä¸¾ä¸ªğŸŒ°  
  ```javascript
  const apis = ['xxx1', 'xxx2']
  apis.forEach(api => {
    fetch(api, function(error, data) {
      if (error) {
        handleError(error)
      } else {
        // do something
      }
    })
  })
  ```
  å½“xxx1å’Œxxx2å¯¹åº”çš„æ•°æ®æ¥å£éƒ½æŒ‚äº†çš„æ—¶å€™ï¼Œå¦‚ä¸‹å›è°ƒå‡½æ•°ä¾ç„¶è¢«è°ƒç”¨äº†ä¸¤æ¬¡ã€‚
  æ­£ç¡®çš„é€»è¾‘åº”è¯¥æ˜¯ç¬¬ä¸€æ¬¡fetchçš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸ï¼Œç„¶åç»ˆæ­¢ç¨‹åºã€‚
  ä½†æ˜¯å› ä¸ºå›è°ƒå‡½æ•°å†…éƒ¨throwçš„å¼‚å¸¸ä¿¡æ¯å‡½æ•°å¤–éƒ¨æ•è·ä¸åˆ°ï¼Œæ‰€ä»¥å›è°ƒé‡Œä¸€èˆ¬ä¸ç”¨throwï¼Œ
  æ‰€ä»¥å¯¼è‡´é”™è¯¯çš„å›è°ƒè¢«æ‰§è¡Œäº†ä¸¤æ¬¡ã€‚  

çœ‹çœ‹ç”¨Promiseæ€ä¹ˆå†™

```javascript
const api = 'xxx'
// fixed 1ï¼Œä»£ç ä¸å†æ¨ªå‘æ‰©å±•
;(new Promise((resolve, reject) => {
  fetch(api, (error, data) => {
    error ? reject(error) : resolve(data)
  })
})).then(res => {
  return fetch(res.api, (error, data) => {
    error ? reject(error) : resolve(data)
  })
}).then(res => {
  return fetch(res.api, (error, data) => {
    if (error) {
      // æ­¤å¤„æŠ›å‡ºçš„é”™è¯¯èƒ½è¢« catch æ•è·
      throw new Error('rejected')
    } else {
      resolve(data)
    }
  })
}).then(res => {
  // ...
}).catch(error => {
  // fixed 2ï¼Œç»Ÿä¸€å¤„ç†é”™è¯¯
})
```

æ‰€ä»¥ï¼ŒPromiseçš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³ä»¥ä¸Šé—®é¢˜çš„ã€‚    

é‚£ä¹ˆ ~

<br>

### ä»€ä¹ˆæ˜¯ Promise
> A Promise is an object that is used as a placeholder for the eventual results of a deferred (and possibly asynchronous) computation.

ä»¥ä¸Šæ˜¯æ ‡å‡†ï¼ˆECMAï¼‰å¯¹Promiseçš„å®šä¹‰ã€‚
é€šä¿—ç‚¹è¯´å°±æ˜¯ï¼šPromise å¯¹è±¡æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼ˆä»£ç†ä¸€ä¸ªå€¼ï¼‰ï¼Œè¢«ä»£ç†çš„å€¼åœ¨Promiseå¯¹è±¡åˆ›å»ºæ—¶å¯èƒ½æ˜¯æœªçŸ¥çš„ã€‚
å®ƒå…è®¸ä½ ä¸ºå¼‚æ­¥ä»£ç æ‰§è¡Œç»“æœçš„æˆåŠŸå’Œå¤±è´¥åˆ†åˆ«ç»‘å®šç›¸åº”çš„å¤„ç†æ–¹æ³•ï¼ˆhandlers ï¼‰ã€‚    

è¿™è®©å¼‚æ­¥æ–¹æ³•å¯ä»¥åƒåŒæ­¥æ–¹æ³•é‚£æ ·è¿”å›å€¼ï¼Œä½†æ˜¯å¹¶éç«‹å³è¿”å›æ‰§è¡Œçš„ç»“æœï¼Œå› ä¸ºæ¯•ç«Ÿæ‰§è¡Œçš„æ˜¯å¼‚æ­¥ä»£ç ï¼Œå› æ­¤ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå¦‚å‰æ‰€è¯´ï¼Œå®ƒæ˜¯ä¸€ä¸ªä»£ç†çš„å¯¹è±¡ï¼Œä»£ç†äº†æœ€ç»ˆè¿”å›çš„å€¼ï¼Œå¯ä»¥åœ¨åæœŸä½¿ç”¨

Promiseæœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€:

* pending: åˆå§‹çŠ¶æ€ã€‚
* fulfilled: æ„å‘³ç€æ“ä½œæˆåŠŸå®Œæˆã€‚
* rejected: æ„å‘³ç€æ“ä½œå¤±è´¥ã€‚

![promiseæµç¨‹ç¤ºæ„å›¾](/images/promises.png)

<br>

### é‚£...æ€ä¹ˆä½¿ç”¨ Promise å‘¢

```javascript
new Promise(
    /* executor */
    function(resolve, reject){...}
);

// pending
const api = 'xxx'
const p = new Promise(function(resolve, reject) {
  fetch(api, function(error, data) {
    error ? reject(error) : resolve(data)
  })
})
```

åˆ›å»ºä¸€ä¸ªPromiseå¯¹è±¡ï¼Œåœ¨executorå‡½æ•°ä½“å†…æ‰§è¡Œå¼‚æ­¥æ“ä½œ ~

<br>
#### [Promise.prototype.then()](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/then)

then() æ–¹æ³•è¿”å›ä¸€ä¸ª Promiseï¼Œç»‘å®šå¤„ç†å¼‚æ­¥ä»£ç æ‰§è¡Œçš„ç»“æœçš„å‡½æ•°ã€‚å®ƒæœ€å¤šéœ€è¦æœ‰ä¸¤ä¸ªå‚æ•°ï¼šPromiseçš„æˆåŠŸå’Œå¤±è´¥æƒ…å†µçš„å›è°ƒå‡½æ•°ã€‚   

è¯­æ³•
```javascript
p.then(onFulfilled, onRejected);

p.then(function(value) {
   // fulfillment
  }, function(reason) {
  // rejection
});
```

<br>
#### [Promise.prototype.catch()](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch)

catch() æ–¹æ³•è¿”å›ä¸€ä¸ªPromiseï¼Œåªå¤„ç†æ‹’ç»çš„æƒ…å†µã€‚å®ƒçš„è¡Œä¸ºä¸è°ƒç”¨Promise.prototype.then(undefined, onRejected) ç›¸åŒã€‚   

è¯­æ³•
```javascript
p.catch(onRejected);

p.catch(function(reason) {
   // rejection
});
```

<br>
#### catch å’Œ onRejected çš„åŒºåˆ«

```javascript
// æ–¹å¼ä¸€
new Promise(function(resolve, reject) {
  1 ? resolve() : reject()
}).then(function() {
  console.log('resolve');
}, function(err) {
  console.log('reject');
})
// æ–¹å¼äºŒ
new Promise(function(resolve, reject) {
  1 ? resolve() : reject()
}).then(function() {
  console.log('resolve');
}).catch(function(err) {
  console.log('reject');
})
// æ–¹å¼ä¸‰
new Promise(function(resolve, reject) {
  1 ? resolve() : reject()
}).then(function() {
  console.log('resolve');
}).then(null, function(err) {
  console.log('reject');
})
```
2 å’Œ 3 å®Œå…¨ä¸€æ ·ã€‚1 å’Œ 2 æœ‰ç»†å¾®çš„åŒºåˆ«ï¼Œå½“ç¬¬ä¸€ä¸ª onFulfilled å†…æŠ›å‡ºå¼‚å¸¸æ—¶ 1 çš„ onRejectedå¹¶ä¸ä¼šè¢«æ‰§è¡Œï¼ˆäºŒè€…ä¸èƒ½åŒæ—¶æ‰§è¡Œï¼‰ï¼Œè€Œ 2 çš„catchå›è°ƒä¼šè¢«æ‰§è¡Œã€‚

Promise.prototype.then(onFulfilled, onRejected) æ–¹æ³•è¿”å›ä¸€ä¸ªç”±onFulfilled/onRejectedç¡®å®šçš„Promiseã€‚  

å½“ onFulfilled / onRejected æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªæ‹’ç»çš„ Promise ï¼Œthen è¿”å›ä¸€ä¸ª rejected Promiseï¼›å½“ onFulfilled / onRejected è¿”å›ä¸€ä¸ª resolves Promiseï¼Œæˆ–è€…è¿”å›ä»»ä½•å…¶ä»–å€¼(æˆ–è€…æ²¡æœ‰åŠ¨æ€çš„è®¾ç½®è¿”å›å€¼)ï¼Œthen è¿”å›ä¸€ä¸ª resolved Promiseã€‚

<br>
#### Promise.all(iterable)
è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promiseå¯¹è±¡ï¼Œè¯¥Promiseå¯¹è±¡åœ¨iterableé‡Œæ‰€æœ‰çš„Promiseå¯¹è±¡éƒ½æˆåŠŸçš„æ—¶å€™æ‰ä¼šè§¦å‘æˆåŠŸï¼Œä¸€æ—¦æœ‰ä»»ä½•ä¸€ä¸ªiterableé‡Œé¢çš„Promiseå¯¹è±¡å¤±è´¥åˆ™ç«‹å³è§¦å‘è¯¥Promiseå¯¹è±¡çš„å¤±è´¥ã€‚è¿™ä¸ªæ–°çš„Promiseå¯¹è±¡åœ¨è§¦å‘æˆåŠŸçŠ¶æ€ä»¥åï¼Œä¼šæŠŠä¸€ä¸ªåŒ…å«iterableé‡Œæ‰€æœ‰Promiseè¿”å›å€¼çš„æ•°ç»„ä½œä¸ºæˆåŠŸå›è°ƒçš„è¿”å›å€¼ï¼Œé¡ºåºè·Ÿiterableçš„é¡ºåºä¿æŒä¸€è‡´ï¼›å¦‚æœè¿™ä¸ªæ–°çš„Promiseå¯¹è±¡è§¦å‘äº†å¤±è´¥çŠ¶æ€ï¼Œå®ƒä¼šæŠŠiterableé‡Œç¬¬ä¸€ä¸ªè§¦å‘å¤±è´¥çš„Promiseå¯¹è±¡çš„é”™è¯¯ä¿¡æ¯ä½œä¸ºå®ƒçš„å¤±è´¥é”™è¯¯ä¿¡æ¯ã€‚Promise.allæ–¹æ³•å¸¸è¢«ç”¨äºå¤„ç†å¤šä¸ªPromiseå¯¹è±¡çš„çŠ¶æ€é›†åˆã€‚

<br>
#### Promise.race(iterable)
å½“iterableå‚æ•°é‡Œçš„ä»»æ„ä¸€ä¸ªå­PromiseæˆåŠŸæˆ–å¤±è´¥åï¼Œçˆ¶Promiseé©¬ä¸Šä¹Ÿä¼šç”¨å­Promiseçš„æˆåŠŸè¿”å›å€¼æˆ–å¤±è´¥è¯¦æƒ…ä½œä¸ºå‚æ•°è°ƒç”¨çˆ¶Promiseç»‘å®šçš„ç›¸åº”å¥æŸ„ï¼Œå¹¶è¿”å›è¯¥Promiseå¯¹è±¡ã€‚

<br>

ä»¥ä¸Šæ˜¯å°é“è¿™æ¬¡çš„æ€»ç»“ ~  

<br>

> æœ€åï¼Œæ€è€ƒä¸€ä¸‹é¢ 4 ä¸ª promise ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ« ï¼Ÿ
  ```javascript
    doSomething().then(function () {
      return doSomethingElse();
    });
    doSomething().then(function () {
      doSomethingElse();
    });
    doSomething().then(doSomethingElse());
    doSomething().then(doSomethingElse);
  ```

<br><br>

å‚è€ƒæ–‡æ¡£ï¼š[MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)ã€[ECMA](http://www.ecma-international.org/ecma-262/7.0/index.html#sec-promise-objects)ã€[We have a problem with promises](https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html)
