---
layout: post
title: æ¨¡å—æœºåˆ¶ ... ğŸ‘ğŸ‘
categories: pages
excerpt: æ¨¡å—æœºåˆ¶
tags: JavaScript
---
# CommonJs è§„èŒƒ
CommonJs è§„èŒƒåˆ†ä¸ºæ¨¡å—å®šä¹‰ã€æ¨¡å—å¼•ç”¨å’Œæ¨¡å—æ ‡è¯†ä¸‰åˆ†éƒ¨åˆ†ã€‚

### æ¨¡å—å®šä¹‰  
åœ¨ Node ä¸­ï¼Œä¸€ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ¨¡å—ã€‚module å¯¹è±¡ä»£è¡¨æ¨¡å—è‡ªèº«ï¼Œ**module.exports** å¯¹è±¡ç”¨äºå¯¼å‡ºå½“å‰æ¨¡å—çš„æ–¹æ³•æˆ–è€…å˜é‡ã€‚

### æ¨¡å—å¼•ç”¨  
**require()** ç”¨äºå¼•å…¥ä¸€ä¸ªæ¨¡å—çš„ API åˆ° å½“å‰ä¸Šä¸‹æ–‡ä¸­ã€‚

å¼•å…¥æ¨¡å—éœ€è¦ç»å†å¦‚ä¸‹3ä¸ªæ­¥éª¤ã€‚
* è·¯å¾„åˆ†æ
* æ–‡ä»¶å®šä½

* ç¼–è¯‘æ‰§è¡Œ
  æ¯ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ã€‚
  ```JavaScript
  function Module(id, parent) {
      this.id = id
      this.exports = {}
      this.parent = parent
      if (parent && parent.children) {
          parent.children.push(this)
      }

      this.filename = null
      this.loaded = false
      this.children = []
  }
  ```
  å®šä½åˆ°å…·ä½“æ–‡ä»¶åï¼ŒNode ä¼šæ–°å»ºä¸€ä¸ªæ¨¡å—å¯¹è±¡ï¼Œç„¶åæ ¹æ®è·¯å¾„è½½å…¥å¹¶ç¼–è¯‘ã€‚å¯¹äºä¸åŒçš„æ–‡ä»¶æ‰©å±•åï¼Œå…¶è½½å…¥çš„æ–¹æ³•ä¹Ÿæœ‰æ‰€ä¸åŒï¼Œå…·ä½“å¦‚ä¸‹æ‰€ç¤ºã€‚  
  * .js æ–‡ä»¶ã€‚é€šè¿‡ fs æ¨¡å—åŒæ­¥è¯»å–æ–‡ä»¶åç¼–è¯‘æ‰§è¡Œ
  * .node æ–‡ä»¶ã€‚è¿™æ˜¯ç”¨ C/C++ ç¼–å†™çš„æ‰©å±•æ–‡ä»¶ï¼Œé€šè¿‡ dlopen() æ–¹æ³•åŠ è½½æœ€åç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶ã€‚
  * .json æ–‡ä»¶ã€‚é€šè¿‡ fs æ¨¡å—åŒæ­¥è¯»å–æ–‡ä»¶åï¼Œç”¨ JSON.parse() è§£æè¿”å›ç»“æœ
  * å…¶ä½™æ‰©å±•åæ–‡ä»¶ã€‚å½“åš .js æ–‡ä»¶è½½å…¥

æ¯ä¸€ä¸ªç¼–è¯‘æˆåŠŸçš„æ¨¡å—éƒ½ä¼šå°†å…¶è·¯å¾„ä½œä¸ºç´¢å¼•ç¼“å­˜åœ¨ **Module._cache** å¯¹è±¡ä¸Šã€‚  

äº‹å®ä¸Šï¼ŒNode å¯¹è·å–çš„ Js æ–‡ä»¶å†…å®¹è¿›è¡Œäº†å¤´å°¾åŒ…è£…ã€‚åœ¨å¤´éƒ¨æ·»åŠ  `(function (exports, require, module, __filename, __dirname) {\n`ï¼Œåœ¨å°¾éƒ¨æ·»åŠ  `\n});`ã€‚è¿™æ ·æ¯ä¸ªæ–‡ä»¶ä¹‹é—´éƒ½è¿›è¡Œäº†ä½œç”¨åŸŸéš”ç¦»ã€‚åŒ…è£…ä¹‹åçš„ä»£ç ä¼šé€šè¿‡ **vm** åŸç”Ÿæ¨¡å—çš„ **runInThisContext()** æ–¹æ³•æ‰§è¡Œï¼Œè¿”å›ä¸€ä¸ªå…·ä½“çš„ function å¯¹è±¡ã€‚

> è¿™å°±æ˜¯ä¸ºä»€ä¹ˆèƒ½åœ¨æ¨¡å—å†…ç›´æ¥ä½¿ç”¨`require`ã€`exports`ã€`__dirname`ç­‰å˜é‡çš„åŸå› ã€‚

### æ¨¡å—æ ‡è¯†  
å°±æ˜¯ä¼ ç»™ **require()** çš„å‚æ•°ï¼Œå®ƒéœ€è¦ç¬¦åˆå°é©¼å³°å‘½åçš„å­—ç¬¦ä¸²ï¼Œæˆ–è€…ä»¥.ã€..å¼€å¤´çš„ç›¸å¯¹è·¯å¾„ï¼Œæˆ–è€…ç»å¯¹è·¯å¾„ã€‚


# AMD è§„èŒƒ
å¼‚æ­¥çš„ï¼Œå‰ç½®åŠ è½½å¹¶æ‰§è¡Œæ‰€æœ‰ä¾èµ–æ¨¡å—ã€‚

æºç é˜…è¯»ï¼š[RequireJs çš„ä¸»è¦ä»£ç ](https://github.com/eplover/tricks/blob/master/js/src/requirejs-code-reading.js)

# CMD è§„èŒƒ
ä¸€æ­¥çš„ï¼Œå‰ç½®åŠ è½½æ‰€æœ‰ä¾èµ–æ¨¡å—ï¼Œæ‰§è¡Œåˆ° require çš„æ—¶å€™æ‰æ‰§è¡Œç›¸åº”ä¾èµ–æ¨¡å—çš„ä»£ç ã€‚

æºç é˜…è¯»ï¼š[å®ä¾‹è§£æ SeaJS å†…éƒ¨æ‰§è¡Œè¿‡ç¨‹](https://github.com/seajs/seajs/issues/308)ã€[SeaJS v1.2 ä¸­æ–‡æ³¨é‡Šç‰ˆ](https://github.com/seajs/seajs/issues/305)

# æ¯”è¾ƒ
CommonJs è§„èŒƒçš„ç“¶é¢ˆåœ¨äºå¸¦å®½ï¼Œé€‚ç”¨äºæœåŠ¡å™¨ç«¯ã€‚  
AMD/CMD è§„èŒƒçš„ç“¶é¢ˆåœ¨äº CPU å’Œå†…å­˜ç­‰èµ„æºï¼Œé€‚ç”¨äºæµè§ˆå™¨ç«¯ã€‚

# å…¼å®¹å¤šç§æ¨¡å—è§„èŒƒ
```JavaScript
;(function (name, definition) {
    // æ£€æµ‹ä¸Šä¸‹æ–‡ç¯å¢ƒæ˜¯å¦ä¸ºAMDæˆ–CMD
    var hasDefine = typeof define === 'function',
        // æ£€æµ‹ä¸Šä¸‹æ–‡ç¯å¢ƒæ˜¯å¦ä¸ºNode
        hasExports = typeof module !== 'undefined' && module.exports

    if (hasDefine) {
        define(definition)
    } else if (hasExports) {
        module.exports = definition()
    } else {
        // å°†æ¨¡å—çš„æ‰§è¡Œç»“æœæŒ‚åœ¨windowå˜é‡ä¸­ï¼Œåœ¨æµè§ˆå™¨ä¸­åŠ thisæŒ‡å‘windowå¯¹è±¡
        this[name] = definition()
    }
})('sayhi', function () {
    var sayHi = function () {
        return 'Hi.'
    }

    return sayHi
})
```
